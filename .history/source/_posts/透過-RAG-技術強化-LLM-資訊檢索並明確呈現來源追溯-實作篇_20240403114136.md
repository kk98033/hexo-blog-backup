---
title: 透過 RAG 技術強化 LLM 資訊檢索並明確呈現來源追溯-實作篇
date: 2024-04-03 10:21:51
tags:
  - LLM
categories:
  - 學習筆記
excerpt: 最近在解決 LLM 回答問題準確度的問題，我找到了一項名為 RAG（Retrieval-Augmented Generation）的技術，這是一種旨在提升大型語言模型回答品質的方法。 RAG 通過先行檢索相關資料，然後基於這些資料生成回答，這種方式不僅可以增強了模型的回答能力，還提供了一種機制來追溯資訊源頭。
description: 本篇文章將會使用之前所提到的 RAG 技術，實作一個可以返回資訊來源的 LLM
---

# 透過 RAG 技術強化 LLM 資訊檢索並明確呈現來源追溯-實作篇

本篇文章將會使用上一篇文章所提到的 [RAG](https://blog.iddle.dev/public/2024/04/02/%E9%80%8F%E9%81%8E-RAG-%E6%8A%80%E8%A1%93%E5%BC%B7%E5%8C%96-LLM-%E8%B3%87%E8%A8%8A%E6%AA%A2%E7%B4%A2%E4%B8%A6%E6%98%8E%E7%A2%BA%E5%91%88%E7%8F%BE%E4%BE%86%E6%BA%90%E8%BF%BD%E6%BA%AF/) 技術，實作一個可以返回資訊來源的 LLM

接下來我會參考這篇 [blog](https://zilliz.com/blog/retrieval-augmented-generation-with-citations) 的文章（文章裡面的 LlamaIndex 語法跟目前的版本有所差異 -_-），在 Google Colab 使用 [Milvus](https://milvus.io/) 和 [LlamaIndex](https://docs.llamaindex.ai/en/stable/) 搭建一個基於大型語言模型（LLM）的檢索增強生成模型（RAG）查詢引擎。

此專案會使用到：
1. Milvus：Milvus 是一個開源的向量數據庫，專為提供高效的相似性搜索和向量索引而設計。它能夠處理大規模的向量數據，適用於各種AI應用，如推薦系統、影像識別和自然語言處理等。
2. Milvus Lite：Milvus Lite 是 Milvus 的輕量版本，專為與 Google Colab 和 Jupyter Notebook 無縫配合而設計。
3. LlamaIndex：LlamaIndex 是一個為語言模型設計的索引和檢索框架，它提供了建立、管理和利用索引來增強語言模型檢索性能的工具。
4. OpenAI embeddings：我們使用他語義檢索技術來增強大型語言模型（LLM）的能力，以及利用其生成向量嵌入的能力來改善文檔檢索的精確度和相關性。

### 安裝相關套件
{% codeblock [line_number:true] [highlight:true]%}
!pip install milvus
!pip install milvus python-dotenv
!pip install llama-index
!pip install llama-index-vector-stores-milvus
{% endcodeblock %}

#### 設定 API KEY
{% note danger %}
注意！ 設定 OpenAI api key 環境變數要放在 import SimpleDirectoryReader 之前，不然之後會讀不到 api key，[參考 Github 上面的問題](https://github.com/run-llama/llama_index/issues/6920)
{% endnote %}

設定 API key，API key 記得放在 Google Colab 的 **Secrets** 裡，並且要把 **Notebook access** 打開。

![api key](_posts/透過-RAG-技術強化-LLM-資訊檢索並明確呈現來源追溯-實作篇/key.png)

名字最好取 `OPENAI_API_KEY`

{% codeblock [line_number:true] [highlight:true]%}
import os
from google.colab import userdata

# 設定OpenAI API密鑰
os.environ["OPENAI_API_KEY"] = userdata.get('OPENAI_API_KEY')
{% endcodeblock %}

#### Import 相關套件
{% note info %}
記得要先設定 api key!!
{% endnote %}

{% codeblock [line_number:true] [highlight:true]%}
from llama_index.llms.openai import OpenAI
from llama_index.core.query_engine import CitationQueryEngine
from llama_index.core.indices.vector_store.base import VectorStoreIndex
from llama_index.core import SimpleDirectoryReader
from llama_index.core import StorageContext
# from llama_index.vector_stores.milvus import MilvusVectorStore
from milvus import default_server

from llama_index.core import Settings
from llama_index.embeddings.openai import OpenAIEmbedding
from llama_index.core.node_parser import SentenceSplitter
{% endcodeblock %}

這段另外 import，因為 import 時可能會出現問題

{% codeblock [line_number:true] [highlight:true]%}
from llama_index.vector_stores.milvus import MilvusVectorStore
{% endcodeblock %}

如果你在 import 他時出現：

`ContextualVersionConflict: (grpcio 1.62.1 (/usr/local/lib/python3.10/dist-packages), Requirement.parse('grpcio<=1.60.0,>=1.49.1'), {'pymilvus'})
`

代表你現在的 grpcio 版本不兼容，需要使用以下指令安裝指定的版本 ** (記得當他在問你要不要謝載輸入 "Y" 來確認)**

{% codeblock [line_number:true] [highlight:true]%}
# 卸載 grpcio，然後安裝特定版本的 grpcio（1.60.0）安裝其他的版本可能會導致衝突
!pip uninstall grpcio
!pip install grpcio==1.60.0
{% endcodeblock %}

卸載後可能會叫你 **Restart session**，按下 Restart session 後就可以了，重啟 session 後就可以成功 import 了！

#### 從 PDF 文件中讀取文檔數據
先下載我們這次測試的 pdf 資料（可以是任意的資料），這裡提供我們這組為了專題整理的原住民資料來測試。

用 wget 下載他
{% codeblock [line_number:true] [highlight:true]%}
!wget 'https://drive.google.com/uc?export=download&id=1kDwfFbMC3nM0K7OTXu88cczYBFm10pQT' -O 原住民資料.pdf
{% endcodeblock %}

接下來我們使用 [SimpleDirectoryReader](https://docs.llamaindex.ai/en/stable/examples/data_connectors/simple_directory_reader_parallel/?h=simpledirectoryreader) 來讀取 pdf 數據。

SimpleDirectoryReader 可以從文件目錄中平行處理和讀取文檔數據。它支援從各種類型的文件中提取文本，包括PDF、Word文檔等，並將其轉換為可用於建立索引和進行檢索操作的格式。

{% codeblock [line_number:true] [highlight:true]%}
# 從 PDF 文件中讀取文檔數據。
documents = SimpleDirectoryReader(
    input_files=["./原住民資料.pdf"]
  ).load_data()
print(len(documents))
print(documents)
{% endcodeblock %}


## 參考資料
[Retrieval Augmented Generation with Citations](https://zilliz.com/blog/retrieval-augmented-generation-with-citations)

[Introducing text and code embeddings](https://openai.com/blog/introducing-text-and-code-embeddings)

[Milvus](https://milvus.io/)

[LlamaIndex docs](https://docs.llamaindex.ai/en/stable/)